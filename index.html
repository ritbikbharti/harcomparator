<!-- Ritbik Bharti -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HAR File Comparator</title>
  <style>
    :root {
      --primary: #0097e0; /* Akamai Blue */
      --accent: #03dac5;
      --background: #ffffff;
      --surface: #f1f1f1;
      --on-primary: white;
      --on-surface: black;
    }

    body.dark {
      --background: #121212;
      --surface: #1e1e1e;
      --on-surface: #e0e0e0;
    }

    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      background-color: var(--background);
      color: var(--on-surface);
      margin: 0;
      padding: 0;
    }

    .container {
      padding: 2rem;
      background-color: var(--surface);
    }

    h2 {
      margin-top: 0;
      font-size: 1.8rem;
      font-weight: 500;
    }

    #darkToggleBtn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      color: var(--on-surface);
      transition: background 0.2s;
    }

    #darkToggleBtn:hover {
      background: rgba(100, 100, 100, 0.1);
      border-radius: 8px;
    }

    button {
      background-color: var(--primary);
      color: var(--on-primary);
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s ease;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }

    button:hover {
      background-color: #0077b3;
    }

    input[type="text"], input[type="file"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      margin: 0.5rem 0.5rem 0.5rem 0;
      background-color: white;
      color: black;
    }

    body.dark input[type="text"] {
      background-color: #2a2a2a;
      color: white;
      border: 1px solid #444;
    }

    label {
      display: inline-block;
      margin: 0.5rem 1rem 0.5rem 0;
    }

    .table-container {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead th {
      position: sticky;
      top: 0;
      background-color: var(--surface);
      z-index: 2;
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }

    body.dark thead th {
      background-color: #2b2b2b;
    }

    tbody td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }

    tr:hover {
      background-color: #e6f0ff;
    }

    body.dark tr:hover {
      background-color: #2c2c2c;
    }

    .diff {
      background-color: #f33d3d !important;
      color: black;
    }

    .missing {
      background-color: #e8f13e !important;
      color: black;
    }

    .match {
      background-color: #3ce664 !important;
      color: black;
    }

    body.dark .match {
      background-color: #264d3c !important;
      color: #cceacc;
    }

    .warning {
      color: #d32f2f;
      font-weight: bold;
      margin: 1rem 0;
    }

    .flex-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
    }

    @media (max-width: 600px) {
      .flex-row {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

<button id="darkToggleBtn" onclick="toggleDarkMode()">ðŸŒ— Toggle Dark Mode</button>

<div class="container">
  <h2>HAR File Comparator</h2>

  <div class="flex-row">
    <button onclick="document.getElementById('workingHar').click()">Select Working HAR</button>
    <span id="workingFileName"></span>
    <input type="file" id="workingHar" accept=".har" style="display:none">
  </div>

  <div class="flex-row">
    <button onclick="document.getElementById('nonWorkingHar').click()">Select Non-Working HAR</button>
    <span id="nonWorkingFileName"></span>
    <input type="file" id="nonWorkingHar" accept=".har" style="display:none">
  </div>

  <div class="flex-row">
    <label>Hostname filter: <input type="text" id="hostnameFilter" placeholder="example.com"></label>
    <label>Search URL: <input type="text" id="searchInput" oninput="filterTable()" placeholder="Type to filter..."></label>
    <label><input type="checkbox" id="filterDiffStatus"> Show only requests with status code differences</label>
    <label><input type="checkbox" id="filterMatching"> Show only matching requests</label>
  </div>

  <div class="flex-row">
    <button onclick="compareHARs()">Compare</button>
    <button onclick="exportCSV()">Export CSV</button>
  </div>

  <div id="warning" class="warning"></div>
  <div id="results"></div>
</div>

<script>
  let workingRaw = "", nonWorkingRaw = "";
  let lastComparison = [];

  function toggleDarkMode() {
    document.body.classList.toggle('dark');
    localStorage.setItem('har-dark-mode', document.body.classList.contains('dark') ? 'true' : 'false');
  }

  function loadDarkMode() {
    if (localStorage.getItem('har-dark-mode') === 'true') {
      document.body.classList.add('dark');
    }
  }

  loadDarkMode();

  function readHAR(file, callback, isWorking = false) {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const text = e.target.result;
        const json = JSON.parse(text);
        const entries = json.log.entries.map(entry => ({
          url: entry.request.url,
          status: entry.response.status,
          size: entry.response.content.size
        }));
        if (isWorking) workingRaw = text;
        else nonWorkingRaw = text;
        callback(entries);
      } catch (err) {
        alert("Invalid HAR file: " + file.name);
      }
    };
    reader.readAsText(file);
  }

  document.getElementById('workingHar').addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) {
      document.getElementById('workingFileName').textContent = file.name;
    }
  });

  document.getElementById('nonWorkingHar').addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) {
      document.getElementById('nonWorkingFileName').textContent = file.name;
    }
  });

  function compareHARs() {
    const file1 = document.getElementById('workingHar').files[0];
    const file2 = document.getElementById('nonWorkingHar').files[0];
    const warningEl = document.getElementById('warning');
    warningEl.textContent = '';

    if (!file1 || !file2) {
      alert("Please select both HAR files.");
      return;
    }

    readHAR(file1, data1 => {
      readHAR(file2, data2 => {
        if (workingRaw === nonWorkingRaw) {
          warningEl.textContent = "\u26a0\ufe0f Both HAR files are identical. Please choose different files.";
          document.getElementById('results').innerHTML = "";
          return;
        }
        showComparison(data1, data2);
      }, false);
    }, true);
  }

  function getHostname(url) {
    try {
      return new URL(url).hostname;
    } catch {
      return '';
    }
  }

  function showComparison(working, nonWorking) {
    const mapW = Object.fromEntries(working.map(e => [e.url, e]));
    const mapN = Object.fromEntries(nonWorking.map(e => [e.url, e]));
    const allUrls = new Set([...Object.keys(mapW), ...Object.keys(mapN)]);

    const hostnameFilter = document.getElementById('hostnameFilter').value.trim();
    const filterDiffStatus = document.getElementById('filterDiffStatus').checked;
    const filterMatching = document.getElementById('filterMatching').checked;

    lastComparison = [];
    const rows = [];

    allUrls.forEach(url => {
      const hostname = getHostname(url);
      if (hostnameFilter && !hostname.includes(hostnameFilter)) return;

      const w = mapW[url];
      const n = mapN[url];

      if (filterMatching && (!w || !n)) return;

      const statusDiff = w?.status !== n?.status;
      const sizeDiff = w?.size !== n?.size;

      let category = 'match';
      if (!w || !n) category = 'missing';
      else if (statusDiff || sizeDiff) category = 'diff';

      if (filterDiffStatus && category !== 'diff') return;

      rows.push({
        html: `<tr class="${category}">
          <td>${url}</td>
          <td>${w?.status ?? '-'}</td>
          <td>${n?.status ?? '-'}</td>
          <td>${w?.size ?? '-'}</td>
          <td>${n?.size ?? '-'}</td>
        </tr>`,
        sortIndex: category === 'diff' ? 0 : category === 'match' ? 1 : 2
      });

      lastComparison.push([
        url,
        w?.status ?? '-',
        n?.status ?? '-',
        w?.size ?? '-',
        n?.size ?? '-'
      ]);
    });

    rows.sort((a, b) => a.sortIndex - b.sortIndex);

    let html = '<div class="table-container"><table id="comparisonTable">';
    html += '<thead><tr><th>URL</th><th>Status (Working)</th><th>Status (Non-Working)</th><th>Size (Working)</th><th>Size (Non-Working)</th></tr></thead><tbody>';
    html += rows.map(row => row.html).join('');
    html += '</tbody></table></div>';

    document.getElementById('results').innerHTML = html;
  }

  function exportCSV() {
    if (!lastComparison.length) {
      alert("No comparison to export.");
      return;
    }

    const header = ["URL", "Status (Working)", "Status (Non-Working)", "Size (Working)", "Size (Non-Working)"];
    const rows = [header, ...lastComparison];
    const csvContent = rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'har_comparison.csv';
    a.click();

    URL.revokeObjectURL(url);
  }

  function filterTable() {
    const input = document.getElementById("searchInput").value.toLowerCase();
    const rows = document.querySelectorAll("#comparisonTable tbody tr");

    rows.forEach(row => {
      const urlCell = row.querySelector("td");
      if (urlCell && urlCell.textContent.toLowerCase().includes(input)) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  }
</script>
</body>
</html>